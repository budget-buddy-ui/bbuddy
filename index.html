<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Budget Buddy - Expense Tracker</title>
<style>
body {
font-family: Arial, sans-serif;
margin: 0; padding: 0;
background: #f7f9fc;
color: #333;
}
.container {
max-width: 900px;
margin: 20px auto;
padding: 15px;
background: white;
border-radius: 8px;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
h2 {
text-align: center;
color: #0077cc;
}
input, select, button {
padding: 8px;
margin: 5px 0;
width: 100%;
box-sizing: border-box;
border-radius: 4px;
border: 1px solid #ccc;
font-size: 1em;
}
button {
background-color: #0077cc;
color: white;
border: none;
cursor: pointer;
}
button:hover {
background-color: #005fa3;
}
.message {
margin-top: 10px;
min-height: 18px;
font-weight: bold;
}
.error {
color: #cc0000;
}
.success {
color: green;
}
.form-switch {
text-align: center;
margin-top: 10px;
}
.form-switch a {
color: #0077cc;
cursor: pointer;
text-decoration: underline;
}
#trackerPage {
display: none;
}
.welcome {
font-size: 1.3em;
margin-bottom: 10px;
}
.tips {
background: #e0f2ff;
border-left: 4px solid #0077cc;
padding: 10px;
margin-bottom: 15px;
}
.cards {
display: flex;
gap: 15px;
flex-wrap: wrap;
}
.card {
flex: 1;
min-width: 260px;
background: #f0f9ff;
padding: 15px;
border-radius: 6px;
}
.card h3 {
margin-top: 0;
color: #0077cc;
}
label {
font-weight: bold;
display: block;
margin-top: 10px;
}
.dynamic-expense {
display: flex;
gap: 10px;
margin-top: 5px;
}
.dynamic-expense input[type="text"] {
flex: 2;
}
.dynamic-expense input[type="number"] {
flex: 1;
}
.dynamic-expense button {
flex: 0 0 28px;
background: #cc0000;
font-weight: bold;
font-size: 18px;
line-height: 1;
padding: 0;
border-radius: 4px;
}
.summary {
margin-top: 15px;
background: #d9f7be;
border-left: 4px solid #52c41a;
padding: 15px;
}
.summary div {
margin: 6px 0;
}
.praise-message.success {
color: green;
font-weight: bold;
margin-top: 10px;
}
.praise-message.cheer {
color: #cc5500;
font-weight: bold;
margin-top: 10px;
}
table {
width: 100%;
border-collapse: collapse;
margin-top: 20px;
font-size: 0.9em;
}
th, td {
padding: 8px;
border: 1px solid #ddd;
text-align: center;
}
th {
background-color: #0077cc;
color: white;
}
#logoutBtn {
margin-top: 10px;
background: #cc0000;
}
@media (max-width: 600px) {
.cards {
flex-direction: column;
}
}
</style>
</head>
<body>
<div class="container">

<!-- LOGIN FORM -->
<div id="loginForm">
<h2>Budget Buddy - Login</h2>
<input type="email" id="loginEmail" placeholder="Email" />
<input type="password" id="loginPassword" placeholder="Password" />
<button id="loginBtn">Login</button>
<div class="message error" id="loginError"></div>
<div class="form-switch">
No account? <a id="showSignupLink">Signup here</a> | <a id="showForgotLink">Forgot Password?</a>
</div>
</div>

<!-- SIGNUP FORM -->
<div id="signupForm" style="display:none;">
<h2>Budget Buddy - Signup</h2>
<input type="text" id="signupNickname" placeholder="Nickname" />
<input type="email" id="signupEmail" placeholder="Email" />
<input type="password" id="signupPassword" placeholder="Password (min 6 chars)" />
<button id="signupBtn">Signup</button>
<div class="message error" id="signupError"></div>
<div class="form-switch">
Already have an account? <a id="showLoginLink">Login here</a>
</div>
</div>

<!-- FORGOT PASSWORD FORM -->
<div id="forgotForm" style="display:none;">
<h2>Budget Buddy - Forgot Password</h2>
<input type="email" id="forgotEmail" placeholder="Enter your email" />
<button id="forgotSendBtn">Send Reset Email</button>
<div class="message success" id="forgotMessage"></div>
<div class="message error" id="forgotError"></div>
<div class="form-switch">
Back to <a id="showLoginFromForgot">Login</a>
</div>
</div>

<!-- TRACKER PAGE -->
<div id="trackerPage" style="display:none;">
<div class="welcome">Welcome, <span id="nicknameDisplay"></span>!</div>
<button id="logoutBtn">Logout</button>

<div class="tips">
<strong>Smart Money Management Tips:</strong>
<ul>
<li>Set realistic saving goals and track daily expenses.</li>
<li>Prioritize essential expenses first.</li>
<li>Use the 10% rule: save at least 10% of your allowance.</li>
<li>Limit discretionary spending and avoid impulsive buys.</li>
<li>Review your expenses regularly and adjust your budget.</li>
</ul>
</div>

<label for="datePicker">Date:</label>
<input type="date" id="datePicker" />

<div class="cards">
<div class="card">
<h3>Allowance</h3>
<input type="number" id="allowanceInput" min="0" step="0.01" placeholder="Enter your allowance" />
</div>
<div class="card">
<h3>Fixed Expenses</h3>
<label>Transportation:</label>
<input type="number" id="transportInput" min="0" step="0.01" value="0" />
<label>Meal or Snacks:</label>
<input type="number" id="mealInput" min="0" step="0.01" value="0" />
</div>
<div class="card">
<h3>Other Expenses <button id="addExpenseBtn" title="Add other expense">+</button></h3>
<div id="dynamicExpensesContainer"></div>
</div>
</div>

<button id="calculateBtn" style="margin-top:15px;">Calculate</button>
<button id="submitBtn" style="margin-top:15px;">Submit</button>

<div class="summary">
<div>Allowance: â‚±<span id="summaryAllowance">0.00</span></div>
<div>Total Expenses: â‚±<span id="summaryExpenses">0.00</span></div>
<div>Remaining Balance: â‚±<span id="summaryRemaining">0.00</span></div>
<div>Target Saving (10%): â‚±<span id="summaryTargetSaving">0.00</span></div>
<div>Actual Savings: â‚±<span id="summaryActualSaving">0.00</span></div>
</div>

<div class="praise-message" id="praiseMessage"></div>
<div class="message error" id="calcMessage"></div>

<h3>History</h3>
<div>
Filter by:
<select id="filterMonth">
<option value="all">All Months</option>
<option value="1">January</option>
<option value="2">February</option>
<option value="3">March</option>
<option value="4">April</option>
<option value="5">May</option>
<option value="6">June</option>
<option value="7">July</option>
<option value="8">August</option>
<option value="9">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
<select id="filterYear"></select>
</div>

<table>
<thead>
<tr>
<th>Date</th>
<th>Allowance</th>
<th>Transportation</th>
<th>Meal/Snacks</th>
<th>Other Expenses</th>
<th>Total Expenses</th>
<th>Remaining Balance</th>
<th>Actual Savings</th>
</tr>
</thead>
<tbody id="historyTableBody">
<tr><td colspan="8">No data available.</td></tr>
</tbody>
</table>
</div>
</div>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
    sendPasswordResetEmail,
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
  import {
    getDatabase,
    ref,
    set,
    get,
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  // Firebase config and init (replace with your config)
  const firebaseConfig = {
    apiKey: "AIzaSyAc8HGycdVUdQ_zR9qLu2c-j3bSCkPJj5M",
    authDomain: "budgetbuddy-b0b79.firebaseapp.com",
    databaseURL: "https://budgetbuddy-b0b79-default-rtdb.firebaseio.com",
    projectId: "budgetbuddy-b0b79",
    storageBucket: "budgetbuddy-b0b79.appspot.com",
    messagingSenderId: "1035837798232",
    appId: "1:1035837798232:web:91144e16986d870bb4572d",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // DOM elements
  const loginForm = document.getElementById("login-form");
  const signupForm = document.getElementById("signup-form");
  const trackerSection = document.getElementById("tracker-section");
  const welcomeNickname = document.getElementById("welcome-nickname");
  const logoutBtn = document.getElementById("logout-btn");

  const datePicker = document.getElementById("date-picker");
  const allowanceInput = document.getElementById("allowance");
  const transportInput = document.getElementById("transport");
  const mealInput = document.getElementById("meal");
  const dynamicExpensesContainer = document.getElementById("dynamic-expenses");

  const addExpenseBtn = document.getElementById("add-expense-btn");
  const submitBtn = document.getElementById("submit-btn");

  const summaryAllowance = document.getElementById("summary-allowance");
  const summaryExpenses = document.getElementById("summary-expenses");
  const summaryRemaining = document.getElementById("summary-remaining");
  const summaryTargetSaving = document.getElementById("summary-target-saving");
  const summaryActualSaving = document.getElementById("summary-actual-saving");
  const praiseMessage = document.getElementById("praise-message");
  const calcMessage = document.getElementById("calc-message");

  const historyTableBody = document.getElementById("history-table-body");
  const filterMonth = document.getElementById("filter-month");
  const filterYear = document.getElementById("filter-year");

  // Utilities
  function clearTrackerInputs() {
    allowanceInput.value = "";
    transportInput.value = "";
    mealInput.value = "";
    dynamicExpensesContainer.innerHTML = "";
    praiseMessage.textContent = "";
    calcMessage.textContent = "";
    summaryAllowance.textContent = "0.00";
    summaryExpenses.textContent = "0.00";
    summaryRemaining.textContent = "0.00";
    summaryTargetSaving.textContent = "0.00";
    summaryActualSaving.textContent = "0.00";
  }

  function setDefaultDateToTodayPH() {
    // Philippine timezone offset +8
    const now = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Manila" }));
    datePicker.value = now.toISOString().split("T")[0];
  }

  // Show/hide views
  function showLogin() {
    loginForm.style.display = "block";
    signupForm.style.display = "none";
    trackerSection.style.display = "none";
  }
  function showSignup() {
    loginForm.style.display = "none";
    signupForm.style.display = "block";
    trackerSection.style.display = "none";
  }
  function showTracker() {
    loginForm.style.display = "none";
    signupForm.style.display = "none";
    trackerSection.style.display = "block";
  }

  // Signup and login form handling (unchanged)

  document.getElementById("signup-link").addEventListener("click", e => {
    e.preventDefault();
    showSignup();
  });

  document.getElementById("login-link").addEventListener("click", e => {
    e.preventDefault();
    showLogin();
  });

  signupForm.addEventListener("submit", async e => {
    e.preventDefault();
    const nickname = document.getElementById("signup-nickname").value.trim();
    const email = document.getElementById("signup-email").value.trim();
    const password = document.getElementById("signup-password").value;

    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;
      await set(ref(db, "users/" + user.uid), { nickname, email });
      signupForm.reset();
      alert("Signup successful. Please login.");
      showLogin();
    } catch (error) {
      alert("Signup error: " + error.message);
    }
  });

  loginForm.addEventListener("submit", async e => {
    e.preventDefault();
    const email = document.getElementById("login-email").value.trim();
    const password = document.getElementById("login-password").value;

    try {
      await signInWithEmailAndPassword(auth, email, password);
      loginForm.reset();
    } catch (error) {
      alert("Login error: " + error.message);
    }
  });

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
  });

  // Add dynamic expense row
  addExpenseBtn.addEventListener("click", () => {
    const div = document.createElement("div");
    div.classList.add("dynamic-expense");
    div.innerHTML = `
      <input type="text" placeholder="Description" required />
      <input type="number" min="0" step="0.01" placeholder="Amount" required />
      <button type="button" class="remove-expense-btn">X</button>
    `;
    dynamicExpensesContainer.appendChild(div);

    div.querySelector(".remove-expense-btn").addEventListener("click", () => {
      dynamicExpensesContainer.removeChild(div);
    });
  });

  // Combined calculate & submit function
  submitBtn.addEventListener("click", async () => {
    calcMessage.textContent = "";
    praiseMessage.textContent = "";

    const allowance = parseFloat(allowanceInput.value);
    const transport = parseFloat(transportInput.value);
    const meal = parseFloat(mealInput.value);
    const date = datePicker.value;

    if (!date) {
      calcMessage.textContent = "Please select a date.";
      return;
    }
    if (isNaN(allowance) || allowance < 0) {
      calcMessage.textContent = "Please enter a valid allowance.";
      return;
    }
    if (isNaN(transport) || transport < 0) {
      calcMessage.textContent = "Please enter valid fixed transport expense.";
      return;
    }
    if (isNaN(meal) || meal < 0) {
      calcMessage.textContent = "Please enter valid fixed meal/snacks expense.";
      return;
    }

    // Collect dynamic other expenses
    let otherExpenses = [];
    const rows = dynamicExpensesContainer.querySelectorAll(".dynamic-expense");
    for (const row of rows) {
      const descInput = row.querySelector("input[type='text']");
      const amtInput = row.querySelector("input[type='number']");
      const desc = descInput.value.trim();
      const amt = parseFloat(amtInput.value);
      if (!desc) {
        calcMessage.textContent = "Please enter description for all other expenses.";
        return;
      }
      if (isNaN(amt) || amt < 0) {
        calcMessage.textContent = "Please enter valid amounts for all other expenses.";
        return;
      }
      otherExpenses.push({ description: desc, amount: amt });
    }

    const totalOther = otherExpenses.reduce((sum, e) => sum + e.amount, 0);
    const totalExpenses = transport + meal + totalOther;
    const remaining = allowance - totalExpenses;
    const targetSaving = allowance * 0.1;
    const actualSaving = Math.max(0, remaining);

    // Show summary
    summaryAllowance.textContent = allowance.toFixed(2);
    summaryExpenses.textContent = totalExpenses.toFixed(2);
    summaryRemaining.textContent = remaining.toFixed(2);
    summaryTargetSaving.textContent = targetSaving.toFixed(2);
    summaryActualSaving.textContent = actualSaving.toFixed(2);

    // Praise or cheer messages
    const praiseMsgs = [
      "Awesome! You're hitting your savings goals! ðŸŽ‰",
      "Great job saving today! Keep it up! ðŸ’ª",
      "You're doing fantastic managing your money! ðŸŒŸ",
      "Savings on point! You're a budget pro! ðŸ‘",
      "Way to go! Your financial habits rock! ðŸš€",
    ];
    const cheerMsgs = [
      "Don't give up! Every penny counts! ðŸ˜Š",
      "Keep pushing! Your goals are within reach! ðŸ’ª",
      "Stay motivated! You're improving every day! ðŸŒ±",
      "Cheer up! Small steps lead to big savings! âœ¨",
      "You got this! Tomorrow is a new chance! ðŸŒž",
    ];

    if (actualSaving >= targetSaving) {
      praiseMessage.textContent = praiseMsgs[Math.floor(Math.random() * praiseMsgs.length)];
      praiseMessage.className = "praise-message success";
    } else {
      praiseMessage.textContent = cheerMsgs[Math.floor(Math.random() * cheerMsgs.length)];
      praiseMessage.className = "praise-message cheer";
    }

    // Save data to Firebase
    const user = auth.currentUser;
    if (!user) {
      calcMessage.textContent = "User not authenticated. Please login again.";
      showLogin();
      return;
    }

    const expenseData = {
      date,
      allowance,
      transport,
      meal,
      otherExpenses,
      totalExpenses,
      remaining,
      actualSaving,
      timestamp: Date.now(),
    };

    try {
      await set(ref(db, `expenses/${user.uid}/${date}`), expenseData);
      calcMessage.textContent = "";
      // Refresh history table
      loadHistory();
      clearTrackerInputs();
      setDefaultDateToTodayPH();
    } catch (error) {
      calcMessage.textContent = "Failed to save expense: " + error.message;
    }
  });

  // Load history (unchanged from before)
  async function loadHistory() {
    const user = auth.currentUser;
    if (!user) return;

    const expensesRef = ref(db, `expenses/${user.uid}`);
    const snapshot = await get(expensesRef);
    const data = snapshot.val();

    if (!data) {
      historyTableBody.innerHTML = `<tr><td colspan="8">No data available.</td></tr>`;
      populateYearFilter([]);
      return;
    }

    const expensesArray = [];
    Object.entries(data).forEach(([dateKey, expense]) => {
      expensesArray.push({ date: dateKey, ...expense });
    });

    const yearsSet = new Set(expensesArray.map(e => new Date(e.date).getFullYear()));
    populateYearFilter(Array.from(yearsSet).sort());

    renderHistoryTable(expensesArray);
  }

  function populateYearFilter(years) {
    filterYear.innerHTML = '<option value="all">All Years</option>';
    years.forEach(year => {
      const option = document.createElement("option");
      option.value = year;
      option.textContent = year;
      filterYear.appendChild(option);
    });
  }

  function renderHistoryTable(dataArray) {
    const monthVal = filterMonth.value;
    const yearVal = filterYear.value;

    let filtered = dataArray;

    if (monthVal !== "all") {
      filtered = filtered.filter(e => (new Date(e.date).getMonth() + 1) == monthVal);
    }
    if (yearVal !== "all") {
      filtered = filtered.filter(e => (new Date(e.date).getFullYear()) == yearVal);
    }

    if (filtered.length === 0) {
      historyTableBody.innerHTML = `<tr><td colspan="8">No data available for selected filter.</td></tr>`;
      return;
    }

    filtered.sort((a,b) => new Date(b.date) - new Date(a.date));

    let html = "";
    filtered.forEach(e => {
      let otherDescAmounts = e.otherExpenses?.map(oe => `${oe.description}: â‚±${oe.amount.toFixed(2)}`).join(", ") || "-";

      html += `<tr>
        <td>${e.date}</td>
        <td>â‚±${parseFloat(e.allowance).toFixed(2)}</td>
        <td>â‚±${parseFloat(e.transport).toFixed(2)}</td>
        <td>â‚±${parseFloat(e.meal).toFixed(2)}</td>
        <td>${otherDescAmounts}</td>
        <td>â‚±${parseFloat(e.totalExpenses).toFixed(2)}</td>
        <td>â‚±${parseFloat(e.remaining).toFixed(2)}</td>
        <td>â‚±${parseFloat(e.actualSaving).toFixed(2)}</td>
      </tr>`;
    });

    historyTableBody.innerHTML = html;
  }

  filterMonth.addEventListener("change", loadHistory);
  filterYear.addEventListener("change", loadHistory);

  // Auth state listener to toggle views
  onAuthStateChanged(auth, async user => {
    if (user) {
      const snapshot = await get(ref(db, "users/" + user.uid));
      const userData = snapshot.val();
      welcomeNickname.textContent = userData?.nickname || "Student";

      showTracker();
      setDefaultDateToTodayPH();
      loadHistory();
      clearTrackerInputs();
    } else {
      showLogin();
    }
  });

</script>
</body>
</html>
