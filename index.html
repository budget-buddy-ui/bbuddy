<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Budget Buddy - Expenses Tracker</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f4f7f8;
    color: #333;
  }
  h2 { color: #2a8fbd; }
  section { margin-bottom: 30px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);}
  input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="date"], select {
    padding: 8px; margin: 5px 0 15px 0; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;
  }
  button {
    background-color: #2a8fbd; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;
  }
  button:hover { background-color: #1f668a; }
  a { color: #2a8fbd; cursor: pointer; }
  .hidden { display: none; }
  .flex-row { display: flex; gap: 10px; }
  .dynamic-expense { display: flex; gap: 10px; margin-bottom: 10px; }
  .dynamic-expense input[type="text"], .dynamic-expense input[type="number"] { flex: 1; }
  .remove-expense-btn { background: #c0392b; border-radius: 4px; color: white; padding: 5px 10px; }
  .remove-expense-btn:hover { background: #86281e; }
  table {
    width: 100%; border-collapse: collapse; margin-top: 15px;
  }
  table, th, td {
    border: 1px solid #ccc;
  }
  th, td {
    padding: 8px; text-align: center;
  }
  .praise-message.success { color: green; font-weight: bold; }
  .praise-message.cheer { color: orange; font-weight: bold; }
  #calc-message { color: red; margin-top: 10px; }
</style>
</head>
<body>

<!-- LOGIN FORM -->
<section id="login-form">
  <h2>Login - Budget Buddy</h2>
  <form>
    <label>Email</label>
    <input type="email" id="login-email" required />
    <label>Password</label>
    <input type="password" id="login-password" required />
    <button type="submit">Login</button>
  </form>
  <p><a id="signup-link">Don't have an account? Signup here</a></p>
  <p><a id="forgot-password-link">Forgot Password?</a></p>
</section>

<!-- SIGNUP FORM -->
<section id="signup-form" class="hidden">
  <h2>Signup - Budget Buddy</h2>
  <form>
    <label>Nickname</label>
    <input type="text" id="signup-nickname" required />
    <label>Email</label>
    <input type="email" id="signup-email" required />
    <label>Password</label>
    <input type="password" id="signup-password" required />
    <button type="submit">Signup</button>
  </form>
  <p><a id="login-link">Already have an account? Login here</a></p>
</section>

<!-- TRACKER SECTION -->
<section id="tracker-section" class="hidden">
  <h2>Welcome, <span id="welcome-nickname">Student</span>!</h2>
  <button id="logout-btn">Logout</button>

  <h3>Smart Tips for Money Management</h3>
  <ul>
    <li>Track your expenses daily to avoid overspending.</li>
    <li>Set realistic saving targets and aim to save at least 10% of your allowance.</li>
    <li>Prioritize fixed expenses like transport and meals before other spending.</li>
    <li>Review your spending history regularly to identify patterns.</li>
    <li>Stay motivated and celebrate small wins!</li>
  </ul>

  <h3>Track Your Expenses</h3>
  <label>Date:</label>
  <input type="date" id="date-picker" required />

  <label>Allowance (₱):</label>
  <input type="number" id="allowance" min="0" step="0.01" required />

  <div class="flex-row">
    <div style="flex:1">
      <label>Fixed Transportation (₱):</label>
      <input type="number" id="transport" min="0" step="0.01" value="0" required />
    </div>
    <div style="flex:1">
      <label>Fixed Meal/Snacks (₱):</label>
      <input type="number" id="meal" min="0" step="0.01" value="0" required />
    </div>
  </div>

  <h4>Other Expenses</h4>
  <div id="dynamic-expenses"></div>
  <button id="add-expense-btn" type="button">+ Add Other Expense</button>

  <br/><br/>
  <button id="submit-btn">Submit & Calculate</button>
  <p id="calc-message"></p>

  <h3>Today's Summary</h3>
  <p>Allowance: ₱<span id="summary-allowance">0.00</span></p>
  <p>Total Expenses: ₱<span id="summary-expenses">0.00</span></p>
  <p>Remaining Balance: ₱<span id="summary-remaining">0.00</span></p>
  <p>Target Saving (10%): ₱<span id="summary-target-saving">0.00</span></p>
  <p>Actual Savings: ₱<span id="summary-actual-saving">0.00</span></p>
  <p class="praise-message" id="praise-message"></p>

  <h3>History</h3>
  <label>Filter by Month:</label>
  <select id="filter-month">
    <option value="all">All Months</option>
    <option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option>
    <option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option>
    <option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option>
  </select>

  <label>Filter by Year:</label>
  <select id="filter-year"><option value="all">All Years</option></select>

  <table>
    <thead>
      <tr>
        <th>Date (MM/DD/YYYY)</th>
        <th>Allowance (₱)</th>
        <th>Transportation (₱)</th>
        <th>Meal/Snacks (₱)</th>
        <th>Other Expenses</th>
        <th>Total Expenses (₱)</th>
        <th>Remaining Balance (₱)</th>
        <th>Actual Savings (₱)</th>
      </tr>
    </thead>
    <tbody id="history-table-body">
      <tr><td colspan="8">No data available.</td></tr>
    </tbody>
  </table>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
    sendPasswordResetEmail,
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
  import {
    getDatabase,
    ref,
    set,
    get,
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAc8HGycdVUdQ_zR9qLu2c-j3bSCkPJj5M",
    authDomain: "budgetbuddy-b0b79.firebaseapp.com",
    databaseURL: "https://budgetbuddy-b0b79-default-rtdb.firebaseio.com",
    projectId: "budgetbuddy-b0b79",
    storageBucket: "budgetbuddy-b0b79.appspot.com",
    messagingSenderId: "1035837798232",
    appId: "1:1035837798232:web:91144e16986d870bb4572d",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // Elements
  const loginForm = document.getElementById("login-form");
  const signupForm = document.getElementById("signup-form");
  const trackerSection = document.getElementById("tracker-section");
  const welcomeNickname = document.getElementById("welcome-nickname");
  const logoutBtn = document.getElementById("logout-btn");

  const datePicker = document.getElementById("date-picker");
  const allowanceInput = document.getElementById("allowance");
  const transportInput = document.getElementById("transport");
  const mealInput = document.getElementById("meal");
  const dynamicExpensesContainer = document.getElementById("dynamic-expenses");

  const addExpenseBtn = document.getElementById("add-expense-btn");
  const submitBtn = document.getElementById("submit-btn");

  const summaryAllowance = document.getElementById("summary-allowance");
  const summaryExpenses = document.getElementById("summary-expenses");
  const summaryRemaining = document.getElementById("summary-remaining");
  const summaryTargetSaving = document.getElementById("summary-target-saving");
  const summaryActualSaving = document.getElementById("summary-actual-saving");
  const praiseMessage = document.getElementById("praise-message");
  const calcMessage = document.getElementById("calc-message");

  const historyTableBody = document.getElementById("history-table-body");
  const filterMonth = document.getElementById("filter-month");
  const filterYear = document.getElementById("filter-year");

  // Login form inputs
  const loginEmail = document.getElementById("login-email");
  const loginPassword = document.getElementById("login-password");

  // Signup form inputs
  const signupNickname = document.getElementById("signup-nickname");
  const signupEmail = document.getElementById("signup-email");
  const signupPassword = document.getElementById("signup-password");

  // Links
  const signupLink = document.getElementById("signup-link");
  const loginLink = document.getElementById("login-link");
  const forgotPasswordLink = document.getElementById("forgot-password-link");

  // Helper functions
  function showLogin() {
    loginForm.classList.remove("hidden");
    signupForm.classList.add("hidden");
    trackerSection.classList.add("hidden");
    clearMessages();
  }
  function showSignup() {
    loginForm.classList.add("hidden");
    signupForm.classList.remove("hidden");
    trackerSection.classList.add("hidden");
    clearMessages();
  }
  function showTracker() {
    loginForm.classList.add("hidden");
    signupForm.classList.add("hidden");
    trackerSection.classList.remove("hidden");
    clearMessages();
  }
  function clearMessages() {
    calcMessage.textContent = "";
    praiseMessage.textContent = "";
  }
  function setDefaultDateToTodayPH() {
    // PH timezone offset is UTC+8
    const now = new Date();
    // Convert current UTC time to PH time (UTC+8)
    const utc = now.getTime() + now.getTimezoneOffset() * 60000;
    const phDate = new Date(utc + 8 * 3600000);
    datePicker.value = phDate.toISOString().slice(0, 10);
  }

  function clearTrackerInputs() {
    allowanceInput.value = "";
    transportInput.value = "0";
    mealInput.value = "0";
    dynamicExpensesContainer.innerHTML = "";
    summaryAllowance.textContent = "0.00";
    summaryExpenses.textContent = "0.00";
    summaryRemaining.textContent = "0.00";
    summaryTargetSaving.textContent = "0.00";
    summaryActualSaving.textContent = "0.00";
    praiseMessage.textContent = "";
    calcMessage.textContent = "";
    filterMonth.value = "all";
    filterYear.value = "all";
  }

  // Add dynamic expense input
  function addDynamicExpenseItem(name = "", amount = "") {
    const div = document.createElement("div");
    div.className = "dynamic-expense";

    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.placeholder = "Expense name";
    nameInput.value = name;
    nameInput.required = true;

    const amountInput = document.createElement("input");
    amountInput.type = "number";
    amountInput.min = "0";
    amountInput.step = "0.01";
    amountInput.placeholder = "Amount (₱)";
    amountInput.value = amount;
    amountInput.required = true;

    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.textContent = "Remove";
    removeBtn.className = "remove-expense-btn";
    removeBtn.onclick = () => div.remove();

    div.appendChild(nameInput);
    div.appendChild(amountInput);
    div.appendChild(removeBtn);

    dynamicExpensesContainer.appendChild(div);
  }

  // Calculate and submit handler
  async function handleCalculateAndSubmit() {
    clearMessages();

    const allowance = parseFloat(allowanceInput.value);
    if (isNaN(allowance) || allowance < 0) {
      calcMessage.textContent = "Please enter a valid allowance.";
      return;
    }

    const transport = parseFloat(transportInput.value) || 0;
    const meal = parseFloat(mealInput.value) || 0;

    // Validate dynamic expenses
    const otherExpensesDivs = dynamicExpensesContainer.querySelectorAll(".dynamic-expense");
    let otherExpensesTotal = 0;
    const otherExpensesList = [];
    for (const div of otherExpensesDivs) {
      const inputs = div.querySelectorAll("input");
      const name = inputs[0].value.trim();
      const amount = parseFloat(inputs[1].value);
      if (!name) {
        calcMessage.textContent = "Please fill all other expense names.";
        return;
      }
      if (isNaN(amount) || amount < 0) {
        calcMessage.textContent = "Please enter valid amounts for other expenses.";
        return;
      }
      otherExpensesList.push({ name, amount });
      otherExpensesTotal += amount;
    }

    const totalExpenses = transport + meal + otherExpensesTotal;
    const remaining = allowance - totalExpenses;
    if (remaining < 0) {
      calcMessage.textContent = "Warning: Your expenses exceed your allowance!";
    }

    const targetSaving = allowance * 0.10;
    const actualSaving = remaining > 0 ? remaining : 0;

    // Update summary display
    summaryAllowance.textContent = allowance.toFixed(2);
    summaryExpenses.textContent = totalExpenses.toFixed(2);
    summaryRemaining.textContent = remaining.toFixed(2);
    summaryTargetSaving.textContent = targetSaving.toFixed(2);
    summaryActualSaving.textContent = actualSaving.toFixed(2);

    // Praise or cheer messages
    const praiseMessages = [
      "Great job! You're hitting your savings target!",
      "Awesome! Keep up the smart spending!",
      "You're managing your money wisely!",
      "Fantastic! You're on track with your savings!",
      "Keep it up! Saving smartly is the key!"
    ];
    const cheerMessages = [
      "Don't worry, every penny counts! Try again tomorrow!",
      "Keep pushing! You can achieve your savings target!",
      "Stay positive! Smart money habits take time!",
      "You're learning and growing! Keep going!",
      "Every effort counts! Don't give up!"
    ];

    if (actualSaving >= targetSaving) {
      const msg = praiseMessages[Math.floor(Math.random() * praiseMessages.length)];
      praiseMessage.textContent = msg;
      praiseMessage.className = "praise-message success";
    } else {
      const msg = cheerMessages[Math.floor(Math.random() * cheerMessages.length)];
      praiseMessage.textContent = msg;
      praiseMessage.className = "praise-message cheer";
    }

    // Save data to Firebase
    const user = auth.currentUser;
    if (!user) {
      calcMessage.textContent = "User not authenticated.";
      return;
    }

    const dataToSave = {
      date: datePicker.value,
      allowance: allowance,
      transportation: transport,
      meal: meal,
      otherExpenses: otherExpensesList,
      totalExpenses: totalExpenses,
      remainingBalance: remaining,
      targetSaving: targetSaving,
      actualSaving: actualSaving,
      timestamp: Date.now()
    };

    try {
      await set(ref(db, `expenses/${user.uid}/${dataToSave.date}`), dataToSave);
      loadHistory();
      clearTrackerInputs();
    } catch (error) {
      calcMessage.textContent = "Failed to save expense: " + error.message;
    }
  }

  // Load history data from Firebase and render table with filters
  async function loadHistory() {
    historyTableBody.innerHTML = "<tr><td colspan='8'>Loading...</td></tr>";
    const user = auth.currentUser;
    if (!user) {
      historyTableBody.innerHTML = "<tr><td colspan='8'>Not logged in.</td></tr>";
      return;
    }
    try {
      const snapshot = await get(ref(db, `expenses/${user.uid}`));
      const data = snapshot.val();
      if (!data) {
        historyTableBody.innerHTML = "<tr><td colspan='8'>No data available.</td></tr>";
        return;
      }

      // Flatten data into an array, sort descending by date
      const entries = Object.values(data).sort((a, b) => new Date(b.date) - new Date(a.date));

      // Populate year filter options dynamically
      const yearsSet = new Set();
      entries.forEach(e => yearsSet.add(e.date.slice(0,4)));
      const years = Array.from(yearsSet).sort();
      filterYear.innerHTML = `<option value="all">All Years</option>` +
        years.map(y => `<option value="${y}">${y}</option>`).join("");

      // Filter entries based on month and year filter
      const selectedMonth = filterMonth.value;
      const selectedYear = filterYear.value;

      const filteredEntries = entries.filter(e => {
        const [y, m] = e.date.split("-");
        if (selectedMonth !== "all" && parseInt(m) !== parseInt(selectedMonth)) return false;
        if (selectedYear !== "all" && y !== selectedYear) return false;
        return true;
      });

      if (filteredEntries.length === 0) {
        historyTableBody.innerHTML = "<tr><td colspan='8'>No data available for selected filters.</td></tr>";
        return;
      }

      historyTableBody.innerHTML = "";
      for (const entry of filteredEntries) {
        const dateParts = entry.date.split("-");
        const formattedDate = `${dateParts[1]}/${dateParts[2]}/${dateParts[0]}`;
        // Sum other expenses amounts for display
        const otherSum = entry.otherExpenses.reduce((acc, cur) => acc + cur.amount, 0);
        const otherExpensesStr = entry.otherExpenses.length
          ? entry.otherExpenses.map(oe => `${oe.name}:₱${oe.amount.toFixed(2)}`).join(", ")
          : "-";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${formattedDate}</td>
          <td>₱${entry.allowance.toFixed(2)}</td>
          <td>₱${entry.transportation.toFixed(2)}</td>
          <td>₱${entry.meal.toFixed(2)}</td>
          <td>${otherExpensesStr}</td>
          <td>₱${entry.totalExpenses.toFixed(2)}</td>
          <td>₱${entry.remainingBalance.toFixed(2)}</td>
          <td>₱${entry.actualSaving.toFixed(2)}</td>
        `;
        historyTableBody.appendChild(tr);
      }
    } catch (error) {
      historyTableBody.innerHTML = `<tr><td colspan="8">Error loading history: ${error.message}</td></tr>`;
    }
  }

  // Event Listeners

  // Login submit
  loginForm.querySelector("form").addEventListener("submit", async (e) => {
    e.preventDefault();
    clearMessages();
    try {
      await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
      loginEmail.value = "";
      loginPassword.value = "";
    } catch (error) {
      alert("Login failed: " + error.message);
    }
  });

  // Signup submit
  signupForm.querySelector("form").addEventListener("submit", async (e) => {
    e.preventDefault();
    clearMessages();
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, signupEmail.value, signupPassword.value);
      // Save nickname in Realtime Database
      await set(ref(db, `users/${userCredential.user.uid}`), {
        nickname: signupNickname.value.trim()
      });
      signupNickname.value = "";
      signupEmail.value = "";
      signupPassword.value = "";
    } catch (error) {
      alert("Signup failed: " + error.message);
    }
  });

  // Logout
  logoutBtn.addEventListener("click", () => {
    signOut(auth);
  });

  // Navigation links
  signupLink.addEventListener("click", () => showSignup());
  loginLink.addEventListener("click", () => showLogin());

  // Forgot Password
  forgotPasswordLink.addEventListener("click", () => {
    const email = prompt("Enter your email address to reset password:");
    if (email) {
      sendPasswordResetEmail(auth, email)
        .then(() => alert("Password reset email sent. Please check your inbox."))
        .catch(e => alert("Failed to send reset email: " + e.message));
    }
  });

  // Add dynamic expense button
  addExpenseBtn.addEventListener("click", () => addDynamicExpenseItem());

  // Submit & Calculate button
  submitBtn.addEventListener("click", handleCalculateAndSubmit);

  // Filters for history reload
  filterMonth.addEventListener("change", loadHistory);
  filterYear.addEventListener("change", loadHistory);

  // Auth state change
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      // Load user nickname
      const snapshot = await get(ref(db, `users/${user.uid}`));
      const userData = snapshot.val();
      welcomeNickname.textContent = userData?.nickname || "Student";

      showTracker();
      setDefaultDateToTodayPH();
      loadHistory();
      clearTrackerInputs();
    } else {
      showLogin();
    }
  });

</script>

</body>
</html>
