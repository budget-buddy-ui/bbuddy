<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Budget Buddy</title>
<style>
  /* Basic Reset & Styling */
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    background: #f9f9f9;
    color: #333;
  }
  header {
    background: #0066cc;
    color: white;
    padding: 1rem;
    text-align: center;
    font-size: 1.5rem;
    font-weight: bold;
  }
  main {
    max-width: 900px;
    margin: 1rem auto;
    padding: 1rem;
    background: white;
    box-shadow: 0 0 8px #ccc;
    border-radius: 6px;
  }
  h2 {
    margin-top: 0;
  }
  form {
    max-width: 400px;
    margin: 1rem auto;
  }
  label {
    display: block;
    margin: 0.5rem 0 0.2rem 0;
  }
  input[type="text"],
  input[type="email"],
  input[type="password"],
  input[type="number"],
  select,
  input[type="date"] {
    width: 100%;
    padding: 0.4rem;
    font-size: 1rem;
    box-sizing: border-box;
  }
  button {
    margin-top: 1rem;
    padding: 0.6rem 1rem;
    font-size: 1rem;
    background: #0066cc;
    border: none;
    color: white;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover {
    background: #004999;
  }
  .message {
    margin: 1rem 0;
    padding: 0.5rem 1rem;
    border-radius: 4px;
  }
  .success {
    background-color: #d4edda;
    color: #155724;
  }
  .cheer {
    background-color: #fff3cd;
    color: #856404;
  }
  .hidden {
    display: none;
  }
  .flex-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .card {
    border: 1px solid #ddd;
    padding: 1rem;
    border-radius: 6px;
    background: #fefefe;
  }
  .card.wide {
    flex: 1 1 100%;
  }
  .dynamic-expense {
    margin-top: 0.5rem;
    border-top: 1px dashed #aaa;
    padding-top: 0.5rem;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  table, th, td {
    border: 1px solid #bbb;
  }
  th, td {
    padding: 0.4rem 0.8rem;
    text-align: center;
  }
  th {
    background: #0066cc;
    color: white;
  }
  .link-button {
    background: none;
    border: none;
    color: #0066cc;
    cursor: pointer;
    text-decoration: underline;
    padding: 0;
    font-size: 1rem;
  }
  .small-text {
    font-size: 0.9rem;
    color: #555;
  }
</style>
</head>
<body>

<header>Budget Buddy</header>

<main>

<!-- LOGIN VIEW -->
<section id="login-view">
  <h2>Login</h2>
  <form id="login-form">
    <label for="login-email">Email</label>
    <input type="email" id="login-email" required autocomplete="username" />
    <label for="login-password">Password</label>
    <input type="password" id="login-password" required autocomplete="current-password" />
    <button type="submit">Login</button>
  </form>
  <button class="link-button" id="forgot-password-btn">Forgot Password?</button>
  <p>Don't have an account? <button class="link-button" id="go-signup-btn">Signup here</button></p>
</section>

<!-- SIGNUP VIEW -->
<section id="signup-view" class="hidden">
  <h2>Signup</h2>
  <form id="signup-form">
    <label for="signup-nickname">Nickname</label>
    <input type="text" id="signup-nickname" required />
    <label for="signup-email">Email</label>
    <input type="email" id="signup-email" required autocomplete="email" />
    <label for="signup-password">Password</label>
    <input type="password" id="signup-password" required autocomplete="new-password" />
    <button type="submit">Signup</button>
  </form>
  <p>Already have an account? <button class="link-button" id="go-login-btn">Login here</button></p>
</section>

<!-- TRACKER VIEW -->
<section id="tracker-view" class="hidden">
  <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 1rem;">
    <h2>Welcome, <span id="welcome-nickname">Student</span>!</h2>
    <button id="logout-btn">Logout</button>
  </div>

  <div class="card">
    <h3>Smart Money Management Tips</h3>
    <ul>
      <li>Track your expenses daily to know where your money goes.</li>
      <li>Set a clear savings target and stick to it.</li>
      <li>Limit your spending on non-essential items.</li>
      <li>Use budgeting apps or tools to stay organized.</li>
      <li>Review your expenses weekly and adjust your budget.</li>
    </ul>
  </div>

  <div class="card" style="margin-top: 1rem;">
    <label for="date-picker"><strong>Select Date:</strong></label>
    <input type="date" id="date-picker" required />
  </div>

  <div class="card flex-row" style="margin-top: 1rem;">
    <div class="card" style="flex:1; min-width: 150px;">
      <label for="allowance-input">Allowance (₱)</label>
      <input type="number" id="allowance-input" min="0" step="0.01" value="0" />
    </div>
    <div class="card" style="flex:1; min-width: 150px;">
      <label for="transport-input">Fixed Transportation (₱)</label>
      <input type="number" id="transport-input" min="0" step="0.01" value="0" />
    </div>
    <div class="card" style="flex:1; min-width: 150px;">
      <label for="meal-input">Fixed Meal/Snacks (₱)</label>
      <input type="number" id="meal-input" min="0" step="0.01" value="0" />
    </div>
  </div>

  <div class="card" style="margin-top: 1rem;">
    <h3>Other Expenses</h3>
    <div id="other-expenses-container"></div>
    <button id="add-expense-btn" type="button" style="margin-top: 0.5rem;">+ Add Expense Item</button>
  </div>

  <button id="submit-btn" style="margin-top: 1rem;">Calculate & Submit</button>

  <div id="calc-message" class="message" style="margin-top: 1rem;"></div>

  <div class="card wide" style="margin-top: 1rem;">
    <h3>Today's Summary</h3>
    <p>Allowance: ₱<span id="summary-allowance">0.00</span></p>
    <p>Total Expenses: ₱<span id="summary-total-expenses">0.00</span></p>
    <p>Remaining Balance: ₱<span id="summary-remaining">0.00</span></p>
    <p>Target Saving (10% Allowance): ₱<span id="summary-target-saving">0.00</span></p>
    <p>Actual Savings: ₱<span id="summary-actual-saving">0.00</span></p>
    <p id="praise-message" class="message"></p>
  </div>

  <div class="card wide" style="margin-top: 1rem;">
    <h3>History</h3>
    <div class="flex-row" style="align-items: center; margin-bottom: 0.5rem;">
      <label for="filter-month">Filter by Month:</label>
      <select id="filter-month" style="margin-left: 0.5rem;">
        <option value="all">All Months</option>
        <option value="1">January</option>
        <option value="2">February</option>
        <option value="3">March</option>
        <option value="4">April</option>
        <option value="5">May</option>
        <option value="6">June</option>
        <option value="7">July</option>
        <option value="8">August</option>
        <option value="9">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
      </select>
      <label for="filter-year" style="margin-left: 1rem;">Filter by Year:</label>
      <select id="filter-year" style="margin-left: 0.5rem;">
        <option value="all">All Years</option>
      </select>
    </div>
    <table>
      <thead>
        <tr>
          <th>Date (MM/DD/YYYY)</th>
          <th>Allowance (₱)</th>
          <th>Transport (₱)</th>
          <th>Meal (₱)</th>
          <th>Other Expenses (₱)</th>
          <th>Total Expenses (₱)</th>
          <th>Remaining Balance (₱)</th>
          <th>Actual Savings (₱)</th>
        </tr>
      </thead>
      <tbody id="history-table-body">
        <tr><td colspan="8">Please login to view history.</td></tr>
      </tbody>
    </table>
  </div>
</section>

</main>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import {
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
    onAuthStateChanged, signOut, sendPasswordResetEmail, updateProfile
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
  import {
    getDatabase, ref, set, get, child
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  // Your Firebase config here - REPLACE with your own config
  const firebaseConfig = {
    apiKey: "AIzaSyAc8HGycdVUdQ_zR9qLu2c-j3bSCkPJj5M",
    authDomain: "budgetbuddy-b0b79.firebaseapp.com",
    databaseURL: "https://budgetbuddy-b0b79-default-rtdb.firebaseio.com",
    projectId: "budgetbuddy-b0b79",
    storageBucket: "budgetbuddy-b0b79.appspot.com",
    messagingSenderId: "1035837798232",
    appId: "1:1035837798232:web:91144e16986d870bb4572d"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // DOM Elements
  const loginView = document.getElementById("login-view");
  const signupView = document.getElementById("signup-view");
  const trackerView = document.getElementById("tracker-view");

  const loginForm = document.getElementById("login-form");
  const loginEmail = document.getElementById("login-email");
  const loginPassword = document.getElementById("login-password");
  const forgotPasswordBtn = document.getElementById("forgot-password-btn");
  const goSignupBtn = document.getElementById("go-signup-btn");

  const signupForm = document.getElementById("signup-form");
  const signupNickname = document.getElementById("signup-nickname");
  const signupEmail = document.getElementById("signup-email");
  const signupPassword = document.getElementById("signup-password");
  const goLoginBtn = document.getElementById("go-login-btn");

  const logoutBtn = document.getElementById("logout-btn");
  const welcomeNickname = document.getElementById("welcome-nickname");

  const datePicker = document.getElementById("date-picker");
  const allowanceInput = document.getElementById("allowance-input");
  const transportInput = document.getElementById("transport-input");
  const mealInput = document.getElementById("meal-input");

  const otherExpensesContainer = document.getElementById("other-expenses-container");
  const addExpenseBtn = document.getElementById("add-expense-btn");
  const submitBtn = document.getElementById("submit-btn");

  const calcMessage = document.getElementById("calc-message");

  const summaryAllowance = document.getElementById("summary-allowance");
  const summaryTotalExpenses = document.getElementById("summary-total-expenses");
  const summaryRemaining = document.getElementById("summary-remaining");
  const summaryTargetSaving = document.getElementById("summary-target-saving");
  const summaryActualSaving = document.getElementById("summary-actual-saving");
  const praiseMessage = document.getElementById("praise-message");

  const filterMonth = document.getElementById("filter-month");
  const filterYear = document.getElementById("filter-year");
  const historyTableBody = document.getElementById("history-table-body");

  // Praise & Cheer messages
  const praiseMessages = [
    "Awesome job! You nailed your savings goal!",
    "Keep it up! You're a budgeting superstar!",
    "Fantastic! Saving like a pro!",
    "Great work! Your future self will thank you!",
    "Excellent! You're mastering smart money management!"
  ];

  const cheerMessages = [
    "Don't give up! Every peso counts!",
    "Keep trying! Saving is a journey!",
    "You got this! Small steps lead to big savings!",
    "Stay motivated! Tomorrow is a new chance!",
    "Keep pushing! Budgeting gets easier with practice!"
  ];

  // Utility to format date as MM/DD/YYYY
  function formatDate(date) {
    const mm = (date.getMonth() + 1).toString().padStart(2, "0");
    const dd = date.getDate().toString().padStart(2, "0");
    const yyyy = date.getFullYear();
    return `${mm}/${dd}/${yyyy}`;
  }

  // Set date picker default to today's date (Philippines timezone)
  function setDatePickerToTodayPH() {
    const now = new Date();
    // Philippines is UTC+8, adjust if you want exact local time
    const phOffset = 8 * 60; // in minutes
    const localOffset = now.getTimezoneOffset();
    const phTime = new Date(now.getTime() + (localOffset + phOffset) * 60000);
    const yyyy = phTime.getFullYear();
    const mm = (phTime.getMonth() + 1).toString().padStart(2, "0");
    const dd = phTime.getDate().toString().padStart(2, "0");
    datePicker.value = `${yyyy}-${mm}-${dd}`;
  }

  // Show only one view
  function showView(view) {
    loginView.classList.add("hidden");
    signupView.classList.add("hidden");
    trackerView.classList.add("hidden");
    view.classList.remove("hidden");
  }

  // Clear expense inputs
  function clearExpenseInputs() {
    allowanceInput.value = "0";
    transportInput.value = "0";
    mealInput.value = "0";
    otherExpensesContainer.innerHTML = "";
    setDatePickerToTodayPH();
    calcMessage.textContent = "";
    summaryAllowance.textContent = "0.00";
    summaryTotalExpenses.textContent = "0.00";
    summaryRemaining.textContent = "0.00";
    summaryTargetSaving.textContent = "0.00";
    summaryActualSaving.textContent = "0.00";
    praiseMessage.textContent = "";
  }

  // Add dynamic expense input row
  function addExpenseItem(name = "", amount = "") {
    const div = document.createElement("div");
    div.className = "dynamic-expense flex-row";
    div.style.marginBottom = "0.5rem";
    div.style.gap = "0.5rem";

    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.placeholder = "Item name";
    nameInput.value = name;
    nameInput.required = true;
    nameInput.style.flex = "2";

    const amountInput = document.createElement("input");
    amountInput.type = "number";
    amountInput.min = "0";
    amountInput.step = "0.01";
    amountInput.placeholder = "Amount (₱)";
    amountInput.value = amount;
    amountInput.required = true;
    amountInput.style.flex = "1";

    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.textContent = "Remove";
    removeBtn.style.flex = "0 0 auto";
    removeBtn.style.backgroundColor = "#cc0000";
    removeBtn.style.color = "white";
    removeBtn.style.border = "none";
    removeBtn.style.borderRadius = "3px";
    removeBtn.style.cursor = "pointer";

    removeBtn.addEventListener("click", () => {
      otherExpensesContainer.removeChild(div);
    });

    div.appendChild(nameInput);
    div.appendChild(amountInput);
    div.appendChild(removeBtn);

    otherExpensesContainer.appendChild(div);
  }

  // Calculate total expenses and update summary, returns total expenses & remaining
  function calculateAndShowSummary() {
    const allowance = parseFloat(allowanceInput.value) || 0;
    const transport = parseFloat(transportInput.value) || 0;
    const meal = parseFloat(mealInput.value) || 0;

    // Validate non-negative
    if (allowance < 0 || transport < 0 || meal < 0) {
      calcMessage.textContent = "Allowance and fixed expenses must be non-negative.";
      calcMessage.className = "message cheer";
      return null;
    }

    // Sum dynamic expenses
    let otherExpensesTotal = 0;
    const otherItems = [];
    const children = otherExpensesContainer.children;
    for (let i = 0; i < children.length; i++) {
      const inputs = children[i].getElementsByTagName("input");
      const itemName = inputs[0].value.trim();
      const itemAmount = parseFloat(inputs[1].value);

      if (!itemName) {
        calcMessage.textContent = "Please enter a name for all other expense items.";
        calcMessage.className = "message cheer";
        return null;
      }
      if (isNaN(itemAmount) || itemAmount < 0) {
        calcMessage.textContent = "Other expense amounts must be non-negative numbers.";
        calcMessage.className = "message cheer";
        return null;
      }
      otherExpensesTotal += itemAmount;
      otherItems.push({ name: itemName, amount: itemAmount });
    }

    const totalExpenses = transport + meal + otherExpensesTotal;
    const remaining = allowance - totalExpenses;
    const targetSaving = allowance * 0.10;
    const actualSaving = remaining > 0 ? remaining : 0;

    // Update summary UI
    summaryAllowance.textContent = allowance.toFixed(2);
    summaryTotalExpenses.textContent = totalExpenses.toFixed(2);
    summaryRemaining.textContent = remaining.toFixed(2);
    summaryTargetSaving.textContent = targetSaving.toFixed(2);
    summaryActualSaving.textContent = actualSaving.toFixed(2);

    // Praise or cheer message
    if (actualSaving >= targetSaving) {
      praiseMessage.textContent = praiseMessages[Math.floor(Math.random() * praiseMessages.length)];
      praiseMessage.className = "message success";
    } else {
      praiseMessage.textContent = cheerMessages[Math.floor(Math.random() * cheerMessages.length)];
      praiseMessage.className = "message cheer";
    }

    return {
      allowance,
      transport,
      meal,
      otherItems,
      totalExpenses,
      remaining,
      targetSaving,
      actualSaving
    };
  }

  // Save expense data to Firebase DB
  async function saveExpenseData(userId, dateKey, data, nickname) {
    try {
      // Save under /users/{userId}/history/{dateKey}
      const historyRef = ref(db, `users/${userId}/history/${dateKey}`);
      await set(historyRef, data);

      // Also save nickname under /users/{userId}/profile
      const profileRef = ref(db, `users/${userId}/profile`);
      await set(profileRef, { nickname });

      calcMessage.textContent = "Expense data saved successfully!";
      calcMessage.className = "message success";
    } catch (error) {
      calcMessage.textContent = "Failed to save expense: " + error.message;
      calcMessage.className = "message cheer";
    }
  }

  // Load user nickname from profile
  async function loadUserNickname(userId) {
    try {
      const profileRef = ref(db, `users/${userId}/profile`);
      const snapshot = await get(profileRef);
      if (snapshot.exists()) {
        return snapshot.val().nickname || "Student";
      }
      return "Student";
    } catch {
      return "Student";
    }
  }

  // Load expense history for user and update history table
  async function loadExpenseHistory(userId) {
    try {
      const historyRef = ref(db, `users/${userId}/history`);
      const snapshot = await get(historyRef);
      if (!snapshot.exists()) {
        historyTableBody.innerHTML = `<tr><td colspan="8">No expense history found.</td></tr>`;
        filterYear.innerHTML = '<option value="all">All Years</option>';
        return;
      }
      const data = snapshot.val();

      // Collect all years for filter
      const yearsSet = new Set();
      const entries = [];

      for (const dateKey in data) {
        // dateKey format: yyyy-mm-dd
        const parts = dateKey.split("-");
        if (parts.length !== 3) continue;
        const year = parts[0];
        const month = parts[1];
        const day = parts[2];

        yearsSet.add(year);

        const item = data[dateKey];
        entries.push({
          dateKey,
          dateObj: new Date(`${year}-${month}-${day}`),
          year,
          month: parseInt(month, 10),
          allowance: item.allowance || 0,
          transport: item.transport || 0,
          meal: item.meal || 0,
          otherItems: item.otherItems || [],
          totalExpenses: item.totalExpenses || 0,
          remaining: item.remaining || 0,
          targetSaving: item.targetSaving || 0,
          actualSaving: item.actualSaving || 0
        });
      }

      // Sort entries by date descending
      entries.sort((a, b) => b.dateObj - a.dateObj);

      // Populate year filter options
      filterYear.innerHTML = '<option value="all">All Years</option>';
      Array.from(yearsSet).sort((a, b) => b - a).forEach(y => {
        filterYear.innerHTML += `<option value="${y}">${y}</option>`;
      });

      // Populate month filter options
      filterMonth.innerHTML = '<option value="all">All Months</option>';
      for (let m = 1; m <= 12; m++) {
        filterMonth.innerHTML += `<option value="${m}">${m}</option>`;
      }

      // Store entries globally for filtering
      window.expenseEntries = entries;

      // Show all entries initially
      filterAndShowHistory();

    } catch (error) {
      historyTableBody.innerHTML = `<tr><td colspan="8">Error loading history: ${error.message}</td></tr>`;
    }
  }

  // Filter history entries by month and year
  function filterAndShowHistory() {
    if (!window.expenseEntries) return;

    const selectedYear = filterYear.value;
    const selectedMonth = filterMonth.value;

    const filtered = window.expenseEntries.filter(entry => {
      const yearMatch = selectedYear === "all" || entry.year === selectedYear;
      const monthMatch = selectedMonth === "all" || entry.month === parseInt(selectedMonth, 10);
      return yearMatch && monthMatch;
    });

    if (filtered.length === 0) {
      historyTableBody.innerHTML = `<tr><td colspan="8">No records match the filter.</td></tr>`;
      return;
    }

    historyTableBody.innerHTML = "";

    filtered.forEach(entry => {
      const otherItemsText = entry.otherItems.map(i => `${i.name}: ₱${i.amount.toFixed(2)}`).join(", ");

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${entry.dateKey}</td>
        <td>₱${entry.allowance.toFixed(2)}</td>
        <td>₱${entry.transport.toFixed(2)}</td>
        <td>₱${entry.meal.toFixed(2)}</td>
        <td>${otherItemsText}</td>
        <td>₱${entry.totalExpenses.toFixed(2)}</td>
        <td>₱${entry.remaining.toFixed(2)}</td>
        <td>₱${entry.actualSaving.toFixed(2)}</td>
      `;
      historyTableBody.appendChild(row);
    });
  }

  // On page load
  window.addEventListener("DOMContentLoaded", () => {
    setDatePickerToTodayPH();

    // Attach event listeners
    addExpenseBtn.addEventListener("click", () => addExpenseItem());
    submitBtn.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) {
        calcMessage.textContent = "You must be logged in to save expenses.";
        calcMessage.className = "message cheer";
        return;
      }

      const data = calculateAndShowSummary();
      if (!data) return;

      const nickname = await loadUserNickname(user.uid);
      const dateKey = datePicker.value;

      await saveExpenseData(user.uid, dateKey, data, nickname);

      clearExpenseInputs();
      loadExpenseHistory(user.uid);
    });

    filterMonth.addEventListener("change", filterAndShowHistory);
    filterYear.addEventListener("change", filterAndShowHistory);

    // Firebase auth listener
    onAuthStateChanged(auth, user => {
      if (user) {
        showView(trackerView);
        clearExpenseInputs();
        loadExpenseHistory(user.uid);
      } else {
        showView(loginView);
      }
    });
  });

</script>
</body>
</html>
