<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simple Expense Tracker with Auth</title>
<style>
  /* Old style design — simple and clean */

  body {
    font-family: Arial, sans-serif;
    background: #f9f9f9;
    margin: 0;
    padding: 0;
    color: #333;
  }

  header {
    background: #4CAF50;
    color: white;
    padding: 1rem;
    text-align: center;
  }

  main {
    max-width: 600px;
    margin: 1rem auto;
    background: white;
    padding: 1rem 2rem 2rem 2rem;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    border-radius: 5px;
  }

  h2 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-weight: normal;
  }

  label {
    display: block;
    margin-top: 1rem;
    font-weight: bold;
  }

  input[type="text"],
  input[type="email"],
  input[type="password"],
  input[type="number"],
  input[type="date"],
  select {
    width: 100%;
    padding: 0.5rem;
    box-sizing: border-box;
    margin-top: 0.25rem;
    border: 1px solid #ccc;
    border-radius: 3px;
  }

  button {
    margin-top: 1.5rem;
    padding: 0.6rem 1rem;
    border: none;
    background: #4CAF50;
    color: white;
    border-radius: 3px;
    cursor: pointer;
    font-size: 1rem;
  }

  button:hover {
    background: #45a049;
  }

  .hidden {
    display: none;
  }

  .link-btn {
    background: none;
    border: none;
    color: #4CAF50;
    cursor: pointer;
    padding: 0;
    font-size: 0.9rem;
    text-decoration: underline;
  }

  .dynamic-expense {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .dynamic-expense input[type="text"] {
    flex: 2;
  }

  .dynamic-expense input[type="number"] {
    flex: 1;
  }

  .remove-expense-btn {
    flex: 0 0 auto;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 3px;
    padding: 0 0.5rem;
    cursor: pointer;
  }

  .remove-expense-btn:hover {
    background: #c0392b;
  }

  .summary {
    margin-top: 1.5rem;
    background: #f0f0f0;
    padding: 1rem;
    border-radius: 4px;
  }

  .summary div {
    margin-bottom: 0.5rem;
  }

  .message {
    margin-top: 1rem;
    font-weight: bold;
  }

  .message.success {
    color: green;
  }

  .message.cheer {
    color: #d35400;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    font-size: 0.9rem;
  }

  th, td {
    border: 1px solid #ddd;
    padding: 0.4rem 0.6rem;
    text-align: center;
  }

  th {
    background: #4CAF50;
    color: white;
  }

  .filters {
    margin-top: 1rem;
    display: flex;
    gap: 1rem;
    justify-content: flex-start;
  }

  .logout-btn {
    background: #e74c3c;
    margin-top: 1rem;
    width: 100%;
  }

</style>
</head>
<body>

<header>
  <h1>Student Allowance Tracker</h1>
</header>

<main>

  <!-- LOGIN FORM -->
  <section id="login-section">
    <h2>Login</h2>
    <form id="login-form">
      <label for="login-email">Email</label>
      <input type="email" id="login-email" required />
      <label for="login-password">Password</label>
      <input type="password" id="login-password" required />
      <button type="submit">Login</button>
    </form>
    <p>Don't have an account? <button class="link-btn" id="go-signup-btn">Sign up</button></p>
    <p><button class="link-btn" id="forgot-password-btn">Forgot password?</button></p>
  </section>

  <!-- SIGNUP FORM -->
  <section id="signup-section" class="hidden">
    <h2>Sign Up</h2>
    <form id="signup-form">
      <label for="signup-nickname">Nickname</label>
      <input type="text" id="signup-nickname" required />
      <label for="signup-email">Email</label>
      <input type="email" id="signup-email" required />
      <label for="signup-password">Password</label>
      <input type="password" id="signup-password" required />
      <button type="submit">Sign Up</button>
    </form>
    <p>Already have an account? <button class="link-btn" id="go-login-btn">Login</button></p>
  </section>

  <!-- TRACKER SECTION -->
  <section id="tracker-section" class="hidden">
    <h2>Welcome, <span id="welcome-nickname">Student</span>!</h2>
    <button id="logout-btn" class="logout-btn">Logout</button>

    <form id="tracker-form">
      <label for="date-picker">Date</label>
      <input type="date" id="date-picker" required />

      <label for="allowance-input">Daily Allowance (₱)</label>
      <input type="number" id="allowance-input" min="0" step="0.01" required />

      <label for="transport-input">Transportation (₱)</label>
      <input type="number" id="transport-input" min="0" step="0.01" value="0" />

      <label for="meal-input">Meal (₱)</label>
      <input type="number" id="meal-input" min="0" step="0.01" value="0" />

      <div id="dynamic-expenses-container"></div>
      <button type="button" id="add-expense-btn">Add Other Expense</button>

      <button type="button" id="submit-btn">Submit & Calculate</button>
    </form>

    <div class="summary">
      <div>Allowance: ₱<span id="summary-allowance">0.00</span></div>
      <div>Total Expenses: ₱<span id="summary-expenses">0.00</span></div>
      <div>Remaining Balance: ₱<span id="summary-remaining">0.00</span></div>
      <div>Target Saving (10%): ₱<span id="summary-target-saving">0.00</span></div>
      <div>Actual Saving: ₱<span id="summary-actual-saving">0.00</span></div>
    </div>

    <div id="calc-message" class="message"></div>
    <div id="praise-message" class="message"></div>

    <div class="filters">
      <label for="filter-month">Filter Month</label>
      <select id="filter-month">
        <option value="all">All Months</option>
        <option value="1">January</option>
        <option value="2">February</option>
        <option value="3">March</option>
        <option value="4">April</option>
        <option value="5">May</option>
        <option value="6">June</option>
        <option value="7">July</option>
        <option value="8">August</option>
        <option value="9">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
      </select>

      <label for="filter-year">Filter Year</label>
      <select id="filter-year">
        <option value="all">All Years</option>
      </select>
    </div>

    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Allowance</th>
          <th>Transport</th>
          <th>Meal</th>
          <th>Other Expenses</th>
          <th>Total Expenses</th>
          <th>Remaining</th>
          <th>Actual Saving</th>
        </tr>
      </thead>
      <tbody id="history-table-body">
        <tr><td colspan="8">No data yet.</td></tr>
      </tbody>
    </table>
  </section>

</main>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
  // Your Firebase config - replace with your actual config
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DB_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // Elements
  const loginSection = document.getElementById("login-section");
  const signupSection = document.getElementById("signup-section");
  const trackerSection = document.getElementById("tracker-section");

  const loginForm = document.getElementById("login-form");
  const signupForm = document.getElementById("signup-form");
  const trackerForm = document.getElementById("tracker-form");

  const loginEmail = document.getElementById("login-email");
  const loginPassword = document.getElementById("login-password");

  const signupNickname = document.getElementById("signup-nickname");
  const signupEmail = document.getElementById("signup-email");
  const signupPassword = document.getElementById("signup-password");

  const goSignupBtn = document.getElementById("go-signup-btn");
  const goLoginBtn = document.getElementById("go-login-btn");
  const forgotPasswordBtn = document.getElementById("forgot-password-btn");

  const logoutBtn = document.getElementById("logout-btn");

  const welcomeNickname = document.getElementById("welcome-nickname");

  const datePicker = document.getElementById("date-picker");
  const allowanceInput = document.getElementById("allowance-input");
  const transportInput = document.getElementById("transport-input");
  const mealInput = document.getElementById("meal-input");
  const dynamicExpensesContainer = document.getElementById("dynamic-expenses-container");
  const addExpenseBtn = document.getElementById("add-expense-btn");
  const submitBtn = document.getElementById("submit-btn");

  const summaryAllowance = document.getElementById("summary-allowance");
  const summaryExpenses = document.getElementById("summary-expenses");
  const summaryRemaining = document.getElementById("summary-remaining");
  const summaryTargetSaving = document.getElementById("summary-target-saving");
  const summaryActualSaving = document.getElementById("summary-actual-saving");

  const calcMessage = document.getElementById("calc-message");
  const praiseMessage = document.getElementById("praise-message");

  const filterMonth = document.getElementById("filter-month");
  const filterYear = document.getElementById("filter-year");
  const historyTableBody = document.getElementById("history-table-body");

  // Show/hide sections
  function showLogin() {
    loginSection.classList.remove("hidden");
    signupSection.classList.add("hidden");
    trackerSection.classList.add("hidden");
    clearMessages();
  }
  function showSignup() {
    loginSection.classList.add("hidden");
    signupSection.classList.remove("hidden");
    trackerSection.classList.add("hidden");
    clearMessages();
  }
  function showTracker() {
    loginSection.classList.add("hidden");
    signupSection.classList.add("hidden");
    trackerSection.classList.remove("hidden");
    clearMessages();
  }
  function clearMessages() {
    calcMessage.textContent = "";
    praiseMessage.textContent = "";
  }

  // Default date to today PH timezone
  function setDefaultDateToTodayPH() {
    const now = new Date();
    const utc = now.getTime() + now.getTimezoneOffset() * 60000;
    const phDate = new Date(utc + 8 * 3600000);
    datePicker.value = phDate.toISOString().slice(0, 10);
  }

  // Clear inputs on tracker form
  function clearTrackerInputs() {
    allowanceInput.value = "";
    transportInput.value = "0";
    mealInput.value = "0";
    dynamicExpensesContainer.innerHTML = "";
    summaryAllowance.textContent = "0.00";
    summaryExpenses.textContent = "0.00";
    summaryRemaining.textContent = "0.00";
    summaryTargetSaving.textContent = "0.00";
    summaryActualSaving.textContent = "0.00";
    praiseMessage.textContent = "";
    calcMessage.textContent = "";
    filterMonth.value = "all";
    filterYear.value = "all";
  }

  // Add a dynamic expense input row
  function addDynamicExpenseItem(name = "", amount = "") {
    const div = document.createElement("div");
    div.className = "dynamic-expense";

    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.placeholder = "Expense name";
    nameInput.value = name;
    nameInput.required = true;

    const amountInput = document.createElement("input");
    amountInput.type = "number";
    amountInput.min = "0";
    amountInput.step = "0.01";
    amountInput.placeholder = "Amount (₱)";
    amountInput.value = amount;
    amountInput.required = true;

    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.textContent = "Remove";
    removeBtn.className = "remove-expense-btn";
    removeBtn.onclick = () => div.remove();

    div.appendChild(nameInput);
    div.appendChild(amountInput);
    div.appendChild(removeBtn);

    dynamicExpensesContainer.appendChild(div);
  }

  // Calculate and save data
  async function handleCalculateAndSubmit() {
    clearMessages();

    const allowance = parseFloat(allowanceInput.value);
    if (isNaN(allowance) || allowance < 0) {
      calcMessage.textContent = "Please enter a valid allowance.";
      return;
    }

    const transport = parseFloat(transportInput.value) || 0;
    const meal = parseFloat(mealInput.value) || 0;

    // Validate other expenses
    const otherExpensesDivs = dynamicExpensesContainer.querySelectorAll(".dynamic-expense");
    let otherExpensesTotal = 0;
    const otherExpensesList = [];
    for (const div of otherExpensesDivs) {
      const inputs = div.querySelectorAll("input");
      const name = inputs[0].value.trim();
      const amount = parseFloat(inputs[1].value);
      if (!name) {
        calcMessage.textContent = "Please fill all other expense names.";
        return;
      }
      if (isNaN(amount) || amount < 0) {
        calcMessage.textContent = "Please enter valid amounts for other expenses.";
        return;
      }
      otherExpensesList.push({ name, amount });
      otherExpensesTotal += amount;
    }

    const totalExpenses = transport + meal + otherExpensesTotal;
    const remaining = allowance - totalExpenses;
    if (remaining < 0) {
      calcMessage.textContent = "Warning: Your expenses exceed your allowance!";
    }

    const targetSaving = allowance * 0.10;
    const actualSaving = remaining > 0 ? remaining : 0;

    summaryAllowance.textContent = allowance.toFixed(2);
    summaryExpenses.textContent = totalExpenses.toFixed(2);
    summaryRemaining.textContent = remaining.toFixed(2);
    summaryTargetSaving.textContent = targetSaving.toFixed(2);
    summaryActualSaving.textContent = actualSaving.toFixed(2);

    const praiseMessages = [
      "Great job! You're hitting your savings target!",
      "Awesome! Keep up the smart spending!",
      "You're managing your money wisely!",
      "Fantastic! You're on track with your savings!",
      "Keep it up! Saving smartly is the key!"
    ];
    const cheerMessages = [
      "Don't worry, every penny counts! Try again tomorrow!",
      "Keep pushing! You can achieve your savings target!",
      "Stay positive! Smart money habits take time!",
      "You're learning and growing! Keep going!",
      "Every effort counts! Don't give up!"
    ];

    if (actualSaving >= targetSaving) {
      const msg = praiseMessages[Math.floor(Math.random() * praiseMessages.length)];
      praiseMessage.textContent = msg;
      praiseMessage.className = "message success";
    } else {
      const msg = cheerMessages[Math.floor(Math.random() * cheerMessages.length)];
      praiseMessage.textContent = msg;
      praiseMessage.className = "message cheer";
    }

    // Save to Firebase
    const user = auth.currentUser;
    if (!user) {
      calcMessage.textContent = "User not authenticated. Please login again.";
      return;
    }
    const date = datePicker.value;
    if (!date) {
      calcMessage.textContent = "Please select a date.";
      return;
    }

    const dataToSave = {
      date,
      allowance,
      transport,
      meal,
      otherExpenses: otherExpensesList,
      totalExpenses,
      remaining,
      targetSaving,
      actualSaving,
      timestamp: Date.now()
    };

    try {
      await db.ref(`users/${user.uid}/expenses/${date}`).set(dataToSave);
      calcMessage.textContent = "Data saved successfully!";
      loadHistory();
    } catch (error) {
      calcMessage.textContent = "Error saving data: " + error.message;
    }
  }

  // Load history from Firebase
  async function loadHistory() {
    const user = auth.currentUser;
    if (!user) return;

    const snapshot = await db.ref(`users/${user.uid}/expenses`).once("value");
    const data = snapshot.val() || {};

    // Build a list of years for filterYear dropdown dynamically
    const yearsSet = new Set();
    Object.keys(data).forEach(dateStr => {
      const year = new Date(dateStr).getFullYear();
      yearsSet.add(year);
    });

    // Clear filterYear options except "All Years"
    while (filterYear.options.length > 1) filterYear.remove(1);
    Array.from(yearsSet).sort().forEach(year => {
      const option = document.createElement("option");
      option.value = year;
      option.textContent = year;
      filterYear.appendChild(option);
    });

    renderHistory(data);
  }

  // Render history table with filters
  function renderHistory(data) {
    const monthFilter = filterMonth.value;
    const yearFilter = filterYear.value;

    const dates = Object.keys(data).sort((a,b) => new Date(b) - new Date(a));
    const filteredDates = dates.filter(dateStr => {
      const d = new Date(dateStr);
      if (monthFilter !== "all" && (d.getMonth() + 1).toString() !== monthFilter) return false;
      if (yearFilter !== "all" && d.getFullYear().toString() !== yearFilter) return false;
      return true;
    });

    if (filteredDates.length === 0) {
      historyTableBody.innerHTML = '<tr><td colspan="8">No data to show.</td></tr>';
      return;
    }

    historyTableBody.innerHTML = "";

    filteredDates.forEach(dateStr => {
      const record = data[dateStr];
      const otherExpensesDesc = record.otherExpenses.map(o => `${o.name}: ₱${o.amount.toFixed(2)}`).join(", ");

      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${dateStr}</td>
        <td>₱${record.allowance.toFixed(2)}</td>
        <td>₱${record.transport.toFixed(2)}</td>
        <td>₱${record.meal.toFixed(2)}</td>
        <td>${otherExpensesDesc || "-"}</td>
        <td>₱${record.totalExpenses.toFixed(2)}</td>
        <td>₱${record.remaining.toFixed(2)}</td>
        <td>₱${record.actualSaving.toFixed(2)}</td>
      `;

      historyTableBody.appendChild(tr);
    });
  }

  // Authentication handlers
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    try {
      await auth.signInWithEmailAndPassword(loginEmail.value, loginPassword.value);
    } catch (err) {
      alert("Login failed: " + err.message);
    }
  });

  signupForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    try {
      const userCred = await auth.createUserWithEmailAndPassword(signupEmail.value, signupPassword.value);
      await userCred.user.updateProfile({ displayName: signupNickname.value });
      alert("Account created! Please log in.");
      showLogin();
    } catch (err) {
      alert("Signup failed: " + err.message);
    }
  });

  forgotPasswordBtn.addEventListener("click", async () => {
    const email = prompt("Please enter your email for password reset:");
    if (email) {
      try {
        await auth.sendPasswordResetEmail(email);
        alert("Password reset email sent.");
      } catch (err) {
        alert("Error sending reset email: " + err.message);
      }
    }
  });

  goSignupBtn.addEventListener("click", () => showSignup());
  goLoginBtn.addEventListener("click", () => showLogin());

  logoutBtn.addEventListener("click", () => {
    auth.signOut();
  });

  addExpenseBtn.addEventListener("click", () => addDynamicExpenseItem());

  submitBtn.addEventListener("click", () => handleCalculateAndSubmit());

  filterMonth.addEventListener("change", async () => {
    const user = auth.currentUser;
    if (!user) return;
    const snapshot = await db.ref(`users/${user.uid}/expenses`).once("value");
    renderHistory(snapshot.val() || {});
  });

  filterYear.addEventListener("change", async () => {
    const user = auth.currentUser;
    if (!user) return;
    const snapshot = await db.ref(`users/${user.uid}/expenses`).once("value");
    renderHistory(snapshot.val() || {});
  });

  // On auth state change
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      showTracker();
      welcomeNickname.textContent = user.displayName || "Student";
      setDefaultDateToTodayPH();
      clearTrackerInputs();
      await loadHistory();
    } else {
      showLogin();
    }
  });
</script>

</body>
</html>
